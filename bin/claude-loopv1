#!/usr/bin/env bash
#
# claude-loop - Run Claude Code in a loop with a PRD as input
#
# Inspired by: https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents
#
# Key patterns implemented:
#   - Two-phase approach: init phase sets up environment, work phase makes progress
#   - Progress tracking: claude-progress.md maintains state across sessions
#   - Git checkpointing: commits after each iteration for rollback capability
#   - Startup verification: validates environment before each iteration
#   - Single task focus: one feature/task per iteration to prevent context exhaustion
#

set -euo pipefail

# Configuration
MAX_ITERATIONS=10
ADDITIONAL_PROMPT=""
AUTO_MODE=false
SKIP_INIT=false
NO_CHECKPOINT=false
PRD_FILE=""
PROGRESS_FILE="claude-progress.md"
WORKTREE_DIR=""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

usage() {
    cat << EOF
${BOLD}Usage:${NC} $(basename "$0") <prd-file> [options]

Run Claude Code in a structured loop with a PRD, using progress tracking
and git checkpointing for reliable long-running agent sessions.

${BOLD}Arguments:${NC}
  prd-file                Path to the PRD file (required)

${BOLD}Options:${NC}
  -m, --max-iterations N  Maximum iterations (default: 10)
  -p, --prompt TEXT       Additional instructions for each iteration
  -a, --auto              Run without confirmation prompts (unattended)
  -s, --skip-init         Skip initialization phase (resume existing work)
  -n, --no-checkpoint     Disable git checkpointing
  -d, --dir PATH          Working directory (default: current directory)
  -h, --help              Show this help message

${BOLD}Files Created:${NC}
  claude-progress.md      Progress log maintained across sessions
  init.sh                 Quick environment setup script (init phase only)

${BOLD}Examples:${NC}
  # Start new project
  $(basename "$0") ./PRD.md

  # Resume existing work
  $(basename "$0") ./PRD.md --skip-init

  # Run unattended with 20 iterations
  $(basename "$0") ./PRD.md --auto -m 20

  # Custom working directory
  $(basename "$0") ./PRD.md -d ./my-project

EOF
    exit 0
}

log_info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $1"; }
log_phase()   { echo -e "\n${CYAN}${BOLD}â•â•â•â•â•â• $1 â•â•â•â•â•â•${NC}\n"; }

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -m|--max-iterations) MAX_ITERATIONS="$2"; shift 2 ;;
        -p|--prompt) ADDITIONAL_PROMPT="$2"; shift 2 ;;
        -a|--auto) AUTO_MODE=true; shift ;;
        -s|--skip-init) SKIP_INIT=true; shift ;;
        -n|--no-checkpoint) NO_CHECKPOINT=true; shift ;;
        -d|--dir) WORKTREE_DIR="$2"; shift 2 ;;
        -h|--help) usage ;;
        -*) log_error "Unknown option: $1"; usage ;;
        *)
            if [[ -z "$PRD_FILE" ]]; then
                PRD_FILE="$1"
            else
                log_error "Unexpected argument: $1"
                usage
            fi
            shift
            ;;
    esac
done

# Validation
[[ -z "$PRD_FILE" ]] && { log_error "PRD file is required"; usage; }
[[ ! -f "$PRD_FILE" ]] && { log_error "PRD file not found: $PRD_FILE"; exit 1; }
command -v claude &>/dev/null || { log_error "Claude Code CLI not found"; exit 1; }

# Set working directory
if [[ -n "$WORKTREE_DIR" ]]; then
    mkdir -p "$WORKTREE_DIR"
    cd "$WORKTREE_DIR"
fi
WORK_DIR=$(pwd)

# Resolve PRD to absolute path
PRD_FILE=$(cd "$(dirname "$PRD_FILE")" && pwd)/$(basename "$PRD_FILE")

#
# Phase 1: Initialization
# Creates progress file, init script, and initial git commit
#
run_init_phase() {
    log_phase "INITIALIZATION PHASE"

    local init_prompt
    read -r -d '' init_prompt << 'INIT_EOF' || true
You are initializing a new project. Your goal is to set up the foundation for iterative development.

## Your Tasks:

1. **Read and analyze the PRD** to understand the full scope
2. **Create claude-progress.md** with this structure:
   ```markdown
   # Project Progress

   ## Overview
   [Brief project description from PRD]

   ## Features Checklist
   - [ ] Feature 1: [description]
   - [ ] Feature 2: [description]
   ...

   ## Session Log
   ### Session 1 - [DATE]
   - Initialized project structure
   - [Other setup tasks completed]

   ## Current State
   [What's working, what's next]

   ## Notes
   [Any important decisions or context for future sessions]
   ```

3. **Create init.sh** script that can quickly set up/verify the dev environment:
   ```bash
   #!/bin/bash
   # Quick environment setup - run this to verify everything works
   # Add commands to: install deps, start dev server, run basic tests
   ```

4. **Set up initial project structure** if needed (directories, config files)

5. **Make initial git commit** with message: "chore: initialize project structure"

## Important:
- Break down the PRD into discrete, testable features in the checklist
- Each feature should be completable in a single session
- Document any assumptions or decisions in the Notes section
INIT_EOF

    init_prompt="$init_prompt

## PRD Content:
$(cat "$PRD_FILE")"

    if [[ -n "$ADDITIONAL_PROMPT" ]]; then
        init_prompt="$init_prompt

## Additional Context:
$ADDITIONAL_PROMPT"
    fi

    log_info "Running initialization..."

    set +e
    claude --print "$init_prompt" 2>&1
    local exit_code=$?
    set -e

    if [[ $exit_code -ne 0 ]]; then
        log_error "Initialization failed with exit code: $exit_code"
        exit $exit_code
    fi

    log_success "Initialization complete"
}

#
# Phase 2: Working Loop
# Iteratively completes features with checkpointing
#
build_work_prompt() {
    local iteration=$1
    local progress_content=""

    if [[ -f "$PROGRESS_FILE" ]]; then
        progress_content=$(cat "$PROGRESS_FILE")
    fi

    cat << WORK_EOF
You are continuing work on a project. This is iteration $iteration of $MAX_ITERATIONS.

## Startup Verification (do this first):
1. Run \`pwd\` to confirm you're in the right directory
2. Read claude-progress.md to understand current state
3. Check git status for any uncommitted changes
4. Run init.sh if environment needs setup
5. Do a quick smoke test to verify the app still works

## Your Task This Iteration:
1. Review the Features Checklist in claude-progress.md
2. Pick the NEXT UNCOMPLETED feature (work on ONE feature only)
3. Implement and test that feature thoroughly
4. Update claude-progress.md:
   - Mark the feature as [x] complete
   - Add a session log entry with what you did
   - Update "Current State" section
5. Commit your changes with a descriptive message

## Important Rules:
- Only work on ONE feature per iteration to avoid context exhaustion
- Code must be clean and ready for main branch (no debris)
- Test your changes before marking complete
- If blocked, document the blocker in Notes and move to next feature
- When ALL features are complete, respond with: ALL_TASKS_COMPLETE

## Current Progress File:
$progress_content

## PRD Reference:
$(cat "$PRD_FILE")
WORK_EOF

    if [[ -n "$ADDITIONAL_PROMPT" ]]; then
        echo "
## Additional Instructions:
$ADDITIONAL_PROMPT"
    fi
}

git_checkpoint() {
    local iteration=$1

    if [[ "$NO_CHECKPOINT" == true ]]; then
        return 0
    fi

    if ! git rev-parse --git-dir &>/dev/null; then
        log_warning "Not a git repository, skipping checkpoint"
        return 0
    fi

    if git diff --quiet && git diff --cached --quiet; then
        log_info "No changes to checkpoint"
        return 0
    fi

    log_info "Creating git checkpoint..."
    git add -A
    git commit -m "checkpoint: iteration $iteration progress

ðŸ¤– Generated with claude-loop" || true
    log_success "Checkpoint created"
}

rollback_last() {
    if ! git rev-parse --git-dir &>/dev/null; then
        log_error "Not a git repository"
        return 1
    fi

    local last_checkpoint
    last_checkpoint=$(git log --oneline --grep="checkpoint: iteration" -1 --format="%H" 2>/dev/null || true)

    if [[ -z "$last_checkpoint" ]]; then
        log_error "No checkpoint found to rollback to"
        return 1
    fi

    log_warning "Rolling back to: $(git log -1 --oneline "$last_checkpoint")"
    git reset --hard "$last_checkpoint"
    log_success "Rollback complete"
}

run_work_phase() {
    log_phase "WORK PHASE"

    local iteration=1

    while [[ $iteration -le $MAX_ITERATIONS ]]; do
        echo ""
        log_info "â”â”â” Iteration $iteration of $MAX_ITERATIONS â”â”â”"

        # Build and run prompt
        local prompt
        prompt=$(build_work_prompt "$iteration")

        set +e
        local output
        output=$(claude --print "$prompt" 2>&1)
        local exit_code=$?
        set -e

        echo "$output"

        # Handle errors
        if [[ $exit_code -ne 0 ]]; then
            log_error "Claude exited with code: $exit_code"

            if [[ "$AUTO_MODE" == false ]]; then
                echo ""
                read -p "Retry (r), Rollback (b), or Quit (q)? " -n 1 -r REPLY
                echo ""
                case $REPLY in
                    [Rr]) continue ;;
                    [Bb]) rollback_last; continue ;;
                    *) exit $exit_code ;;
                esac
            else
                exit $exit_code
            fi
        fi

        # Check for completion
        if echo "$output" | grep -q "ALL_TASKS_COMPLETE"; then
            git_checkpoint "$iteration"
            log_success "All tasks completed!"
            return 0
        fi

        # Checkpoint progress
        git_checkpoint "$iteration"

        # User confirmation (unless auto mode)
        if [[ "$AUTO_MODE" == false ]]; then
            echo ""
            read -p "Continue (enter), Rollback (b), or Quit (q)? " -n 1 -r REPLY
            echo ""
            case $REPLY in
                [Bb]) rollback_last; continue ;;
                [Qq]) log_info "Paused at iteration $iteration"; return 0 ;;
            esac
        fi

        ((iteration++))
    done

    log_warning "Reached maximum iterations ($MAX_ITERATIONS)"
}

#
# Main Execution
#
main() {
    echo ""
    echo -e "${BOLD}Claude Loop${NC} - Long-running agent harness"
    echo -e "PRD: ${CYAN}$PRD_FILE${NC}"
    echo -e "Working directory: ${CYAN}$WORK_DIR${NC}"
    echo -e "Max iterations: ${CYAN}$MAX_ITERATIONS${NC}"
    [[ "$AUTO_MODE" == true ]] && echo -e "Mode: ${YELLOW}Unattended${NC}"
    echo ""

    # Run phases
    if [[ "$SKIP_INIT" == false ]]; then
        run_init_phase
    else
        log_info "Skipping init phase (--skip-init)"
        [[ ! -f "$PROGRESS_FILE" ]] && log_warning "No progress file found - consider running without --skip-init"
    fi

    run_work_phase

    log_phase "SESSION COMPLETE"
    log_info "Progress saved in: $PROGRESS_FILE"
    [[ "$NO_CHECKPOINT" == false ]] && log_info "Checkpoints saved in git history"
}

main
